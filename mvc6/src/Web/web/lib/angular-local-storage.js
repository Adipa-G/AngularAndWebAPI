var isDefined=angular.isDefined,isUndefined=angular.isUndefined,isNumber=angular.isNumber,isObject=angular.isObject,isArray=angular.isArray,extend=angular.extend,toJson=angular.toJson;angular.module("LocalStorageModule",[]).provider("localStorageService",function(){this.prefix="ls",this.storageType="localStorage",this.cookie={expiry:30,path:"/"},this.defaultToCookie=!0,this.notify={setItem:!0,removeItem:!1},this.setPrefix=function(e){return this.prefix=e,this},this.setStorageType=function(e){return this.storageType=e,this},this.setDefaultToCookie=function(e){return this.defaultToCookie=!!e,this},this.setStorageCookie=function(e,t){return this.cookie.expiry=e,this.cookie.path=t,this},this.setStorageCookieDomain=function(e){return this.cookie.domain=e,this},this.setNotify=function(e,t){return this.notify={setItem:e,removeItem:t},this},this.$get=["$rootScope","$window","$document","$parse","$timeout",function(e,t,o,r,i){function n(o){if(o||(o=t.event),l.setItem&&h(o.key)){var r=d(o.key);i(function(){e.$broadcast("LocalStorageModule.notification.changed",{key:r,newvalue:o.newValue,storageType:s.storageType})})}}var a,s=this,c=s.prefix,u=s.cookie,l=s.notify,f=s.storageType;o?o[0]&&(o=o[0]):o=document,"."!==c.substr(-1)&&(c=c?c+".":"");var g=function(e){return c+e},d=function(e){return e.replace(new RegExp("^"+c,"g"),"")},h=function(e){return 0===e.indexOf(c)},T=function(){try{var o=f in t&&null!==t[f],r=g("__"+Math.round(1e7*Math.random()));return o&&(a=t[f],a.setItem(r,""),a.removeItem(r)),o}catch(i){return s.defaultToCookie&&(f="cookie"),e.$broadcast("LocalStorageModule.notification.error",i.message),!1}}(),m=function(t,o){if(o=isUndefined(o)?null:toJson(o),!T&&s.defaultToCookie||"cookie"===s.storageType)return T||e.$broadcast("LocalStorageModule.notification.warning","LOCAL_STORAGE_NOT_SUPPORTED"),l.setItem&&e.$broadcast("LocalStorageModule.notification.setitem",{key:t,newvalue:o,storageType:"cookie"}),O(t,o);try{a&&a.setItem(g(t),o),l.setItem&&e.$broadcast("LocalStorageModule.notification.setitem",{key:t,newvalue:o,storageType:s.storageType})}catch(r){return e.$broadcast("LocalStorageModule.notification.error",r.message),O(t,o)}return!0},p=function(t){if(!T&&s.defaultToCookie||"cookie"===s.storageType)return T||e.$broadcast("LocalStorageModule.notification.warning","LOCAL_STORAGE_NOT_SUPPORTED"),b(t);var o=a?a.getItem(g(t)):null;if(!o||"null"===o)return null;try{return JSON.parse(o)}catch(r){return o}},S=function(){var t,o;for(t=0;t<arguments.length;t++)if(o=arguments[t],!T&&s.defaultToCookie||"cookie"===s.storageType)T||e.$broadcast("LocalStorageModule.notification.warning","LOCAL_STORAGE_NOT_SUPPORTED"),l.removeItem&&e.$broadcast("LocalStorageModule.notification.removeitem",{key:o,storageType:"cookie"}),L(o);else try{a.removeItem(g(o)),l.removeItem&&e.$broadcast("LocalStorageModule.notification.removeitem",{key:o,storageType:s.storageType})}catch(r){e.$broadcast("LocalStorageModule.notification.error",r.message),L(o)}},y=function(){if(!T)return e.$broadcast("LocalStorageModule.notification.warning","LOCAL_STORAGE_NOT_SUPPORTED"),[];var t=c.length,o=[];for(var r in a)if(r.substr(0,t)===c)try{o.push(r.substr(t))}catch(i){return e.$broadcast("LocalStorageModule.notification.error",i.Description),[]}return o},v=function(t){var o=c?new RegExp("^"+c):new RegExp,r=t?new RegExp(t):new RegExp;if(!T&&s.defaultToCookie||"cookie"===s.storageType)return T||e.$broadcast("LocalStorageModule.notification.warning","LOCAL_STORAGE_NOT_SUPPORTED"),$();if(!T&&!s.defaultToCookie)return!1;var i=c.length;for(var n in a)if(o.test(n)&&r.test(n.substr(i)))try{S(n.substr(i))}catch(u){return e.$broadcast("LocalStorageModule.notification.error",u.message),$()}return!0},k=function(){try{return t.navigator.cookieEnabled||"cookie"in o&&(o.cookie.length>0||(o.cookie="test").indexOf.call(o.cookie,"test")>-1)}catch(r){return e.$broadcast("LocalStorageModule.notification.error",r.message),!1}}(),O=function(t,r,i){if(isUndefined(r))return!1;if((isArray(r)||isObject(r))&&(r=toJson(r)),!k)return e.$broadcast("LocalStorageModule.notification.error","COOKIES_NOT_SUPPORTED"),!1;try{var n="",a=new Date,s="";if(null===r?(a.setTime(a.getTime()+-864e5),n="; expires="+a.toGMTString(),r=""):isNumber(i)&&0!==i?(a.setTime(a.getTime()+24*i*60*60*1e3),n="; expires="+a.toGMTString()):0!==u.expiry&&(a.setTime(a.getTime()+24*u.expiry*60*60*1e3),n="; expires="+a.toGMTString()),t){var c="; path="+u.path;u.domain&&(s="; domain="+u.domain),o.cookie=g(t)+"="+encodeURIComponent(r)+n+c+s}}catch(l){return e.$broadcast("LocalStorageModule.notification.error",l.message),!1}return!0},b=function(t){if(!k)return e.$broadcast("LocalStorageModule.notification.error","COOKIES_NOT_SUPPORTED"),!1;for(var r=o.cookie&&o.cookie.split(";")||[],i=0;i<r.length;i++){for(var n=r[i];" "===n.charAt(0);)n=n.substring(1,n.length);if(0===n.indexOf(g(t)+"=")){var a=decodeURIComponent(n.substring(c.length+t.length+1,n.length));try{return JSON.parse(a)}catch(s){return a}}}return null},L=function(e){O(e,null)},$=function(){for(var e=null,t=c.length,r=o.cookie.split(";"),i=0;i<r.length;i++){for(e=r[i];" "===e.charAt(0);)e=e.substring(1,e.length);var n=e.substring(t,e.indexOf("="));L(n)}},M=function(){return f},x=function(e,t,o,i){i=i||t;var n=p(i);return null===n&&isDefined(o)?n=o:isObject(n)&&isObject(o)&&(n=extend(n,o)),r(t).assign(e,n),e.$watch(t,function(e){m(i,e)},isObject(e[t]))};T&&(t.addEventListener?t.addEventListener("storage",n,!1):t.attachEvent&&t.attachEvent("onstorage",n));var E=function(){for(var e=0,o=t[f],r=0;r<o.length;r++)0===o.key(r).indexOf(c)&&e++;return e};return{isSupported:T,getStorageType:M,set:m,add:m,get:p,keys:y,remove:S,clearAll:v,bind:x,deriveKey:g,underiveKey:d,length:E,defaultToCookie:this.defaultToCookie,cookie:{isSupported:k,set:O,add:O,get:b,remove:L,clearAll:$}}}]});